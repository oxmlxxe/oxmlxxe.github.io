<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Exploiting XXE in File Parsing Functionality</title>

		<meta name="description" content="">
		<meta name="author" content="Exploiting XXE in File Parsing Functionality">

		<link rel="stylesheet" href="/reveal.js/css/reveal.css">
		<link rel="stylesheet" href="/reveal.js/css/theme/league.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="/reveal.js/lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? '/reveal.js/css/print/pdf.css' : '/reveal.js/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<div class="slides">
				<section>
					<h1>Exploiting XXE in File Upload Functionality</h1>
					<h2>Blackhat USA - 2015</h2>
					<p style="font-size:120%">Will Vandevanter - @_will_is_</p>
				</section>

				<section style="text-align:left">
					<p style="font-size:140%;">Agenda (25 minutes):</p>
					<ul style="margin-left:10%">
						<li style="font-size:140%;" class="fragment">OOXML Intro</li>
						<li style="font-size:140%;" class="fragment">XML Entity Examples</li>
						<li style="font-size:140%;" class="fragment">Further Exploitation</li>
					</ul>
					<br>
					<p><u>Corrected Slides, References, and Code:</u></p>
					<p style="font-size:160%; margin-left:10%">oxmlxxe.github.io</p>
				</section>
				</section>
				<section>
					<h2 style="text-align:left">Office Open XML (OpenXML; OOXML; OXML)</h2>
					<ul style="font-size:150%">
						<li class="fragment">*.docx, *.pptx, *.xlsx</li>
						<li class="fragment">"Open" File Format developed by Microsoft</li>
						<li class="fragment">Available for Office 2003, Default in Office 2007</li>
						<li class="fragment">ZIP archive containing XML and media files</li>
					</ul>
				</section>

				<section>
				<img width="800" height="600" data-src="./oxml_file_cont.gif">
				</section>

				<section style="font-size:130%">
					<h2>General Parsing OOXML</h2>
					<ol>
						<li>/_rels/.rels</li>
						<li>[Content_Types].xml</li>
						<li>Default Main Document Part</li>
						<ul>
							<li>/word/document.xml</li>
							<li>/ppt/presentation.xml</li>
							<li>/xl/workbook.xml</li>
						</ul>
					</ol>
				</section>
				<section style="text-align:left; width:120%">
					<img src="./word_doc.png" height="150" width="150" class="fragment">
					<img src="./unzip1.png" height="225" width="225" class="fragment">
					<img src="./xml.png" height="225" width="225" class="fragment">
					<img src="./zip.png" height="225" width="225" class="fragment">
					<img src="./word_doc.png" height="150" width="150" class="fragment"><br>
					<img src="./arrow.png" style="transform: rotate(180deg); -webkit-transform: rotate(180deg); -webkit-transform: inverse(100%);" height="150" width="150" class="fragment">
					<img src="./unzip1.png" height="225" width="225" class="fragment">
					<img src="./xml.png" height="225" width="225" class="fragment">
					<img src="./dollar.png" height="225" width="225" class="fragment">
				</section>

				<section style="font-size:130%">
					<h2>Bug Bounty: Slack.com</h2>
					<ul style="text-align: left; font-size:130%">
						<li> File Sharing Functionality </li>
						<li style="color: #E80000"><b>[Content_Types].xml</b></li>
					</ul>
				</section>
				<section style="font-size:130%">
					<h2>Bug Bounty: Facebook Careers</h2>
					<ul style="text-align: left; font-size:130%">
						<li> Q4 2014 - Mohamed Ramadan </li>
						<li>Resume Upload Functionality</li>
					</ul>
				</section>

				<section>
					<h2 style="text-align: left; font-size:250%; margin-left:10%">oxml_xxe demo</h2>
						<p style="text-align: left; font-size:180%; margin-left:15%"> External DTD PoC </p>
				</section>
<section>
<div style="background-color: rgb(20, 98, 135); width: 70%; height: 125%; position: absolute; top: -6%; left: -45%; z-index: -1;">
</div>
<div>
    <div style="width:20%; display: inline-block; margin-right: 5%; vertical-align:top">
        <p style="text-align: left;">
        <h2>XML Entity</h2>
        <p style="text-align: left;">&nbsp;</p>
        <p style="text-align: left;">&nbsp;</p>
        <p style="text-align: left;">&nbsp;</p>
        <p style="text-align: left;">&nbsp;</p>
        <p style="text-align: left;">&nbsp;</p>
        <p style="text-align: left;">&nbsp;</p>

        </p>
    </div>
    <div style="width: 70%; display: inline-block;">
       <p style="text-align: left; font-weight: bold;">
	<&nbsp;!DOCTYPE root [<br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<&nbsp;!ENTITY post <span style="color: rgb(204, 153, 204);">"MYSTRING"<span style="color: rgb(249, 145, 87);"></span></span>><br>
	]>
</p>
	<h3 style="text-align: left;">DOCX</h3>
	    <p style="text-align: left;">/word/document.xml</p>
    <h3 style="text-align: left;">PPTX</h3>
	    <p style="text-align: left;">/ppt/presentation.xml</p>
     <h3 style="text-align: left;">XLSX</h3>
	    <p style="text-align: left;">/xl/workbook.xml</p>
</div>
</section>

<section>
<section>
<div style="background-color: rgb(20, 98, 135); width: 70%; height: 130%; position: absolute; top: -6%; left: -45%; z-index: -1;">
</div>
<div>
    <div style="width:24%; display: inline-block; margin-right: 5%; vertical-align:top">
        <p style="text-align: left;">
        <h2>Recursive XML Entity</h2>
        </p>
    </div>
    <div style="width: 70%; display: inline-block;">
       <p style="text-align: left; font-weight: bold;">
	<&nbsp;!DOCTYPE foo [<br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<&nbsp;!ENTITY post "1"><br>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<&nbsp;!ENTITY post1 "&post;&post;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<&nbsp;!ENTITY post2 "&post1;&post1;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<&nbsp;!ENTITY post3 "&post2;&post2;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<&nbsp;!ENTITY post4 "&post3;&post3;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<&nbsp;!ENTITY post5 "&post4;&post4;">
	<br>]>
	<br><br><span style="color: rgb(249, 145, 87);"><&nbsp;foo>&nbsp;&post5;&nbsp;<&nbsp;/foo></span><br><br><br>
				</p>
       </div>
</div>
</section>
<section>
<div style="background-color: rgb(20, 98, 135); width: 70%; height: 140%; position: absolute; top: -8%; left: -45%; z-index: -1;">
</div>
<div>
    <div style="width:24%; display: inline-block; margin-right: 5%; vertical-align:top">
        <p style="text-align: left;">
        <h2>Recursive XML Entity</h2>
        </p>
    </div>
    <div style="width: 70%; display: inline-block;">
		<h3 style="text-align: left;">Apache POI</h3>
		<p style="text-align: left;">CVE-2014-3574</h3>
		<p style="text-align: left;">CVE-2014-3529</h3>
		<h3 style="text-align: left;">docx4j</h3>
		<h3 style="text-align: left;">OpenXML SDK</h3>
		<h3 style="text-align: left;">Nokogiri</h3>
		<p style="text-align: left;">CVE-2012-6685 (ish)</p>
		<p style="text-align: left;">CVE-2014-3660</p>
       </div>
</div>
</section>
</section>

<section style="text-align:left">
<div style="background-color: rgb(232,0,0); width: 35%; height: 250%; position: absolute; top: -10%; left: -45%; z-index: -1;">
</div>
<div>
    <div style="height:6%;"><h2>+OXML_XXE</h2>
    </div>
       <p class="fragment" style="font-size:160%; margin-left:10%">XSS Testing</p>
       <p class="fragment" style="font-size:160%; margin-left:10%">LFI</p>
       	<p style="text-align: left; font-size:140%; margin-left:15%" class="fragment">Relationship Id="rId1" Type="...relationships/officeDocument" Target="<span style="color: rgb(249, 145, 87);">/word/document.xml</span>"</p>
       <p class="fragment" style="font-size:160%; margin-left:10%">Other File Formats</p>
</div>
</section>

<section style="text-align:left">
<div style="background-color: rgb(232,0,0); width: 35%; height: 250%; position: absolute; top: -10%; left: -45%; z-index: -1;">
</div>
<div>
    <div style="height:6%;"><h2>+OXML Features</h2>
    </div>
       <p class="fragment" style="font-size:160%; margin-left:10%">hlinkHover</p>
       <p class="fragment" style="font-size:160%; margin-left:10%">XSLTransform</p>
       <p class="fragment" style="font-size:160%; margin-left:10%">Embedded "Documents"</p>
       <p class="fragment" style="font-size:160%; margin-left:10%">SSRF</p>
</div>
</section>

<section style="text-align:left">
<div style="background-color: rgb(232,0,0); width: 35%; height: 250%; position: absolute; top: -10%; left: -45%; z-index: -1;">
</div>
<div>
    <div style="height:6%;"><h2>+Testing Cheatsheet</h2>
    </div>
       <p class="fragment" style="font-size:130%; margin-left:-1%">Classic (X)XE in OXML</p>
       <p class="fragment" style="font-size:130%; margin-left:-1%">Canary Testing DTD and XE</p>
       <p class="fragment" style="font-size:130%; margin-left:-1%">XSS XE testing (CDATA/plain/attr)</p>
       <p class="fragment" style="font-size:130%; margin-left:-1%">XE LFI</p>
       <p class="fragment" style="font-size:130%; margin-left:-1%">Embedded (X)XE attacks</p>
       <p class="fragment" style="font-size:130%; margin-left:-1%">SSRF (X)XE</p>
       <p class="fragment" style="font-size:130%; margin-left:-1%">"Save As" Document Conversion</p>
</div>
</section>

<section>
<div style="background-color:#00FF00; width: 35%; height: 250%; position: absolute; top: -10%; left: -45%; z-index: -1;">
</div>
<div>
    <div style="height:6%; text-align:left"><h2>Summary Points</h2>
    </div>
       <p style="font-size:100%" class="fragment">(DEFENSE) The libraries that parse XML on one part of the site (e.g. API) may not be the same ones that parse uploaded files; verify! Check configurations.</p>
       <p class="fragment">(DEFENSE) Patches exist, many are recent</p>
       <p class="fragment">(OFFENSE) Lots of surface area for exploitation</p>
       <p class="fragment">(OFFENSE) Untouched research targets</p>
</div>
</section>

				<section style="text-align: left;">
					<h1>Questions?</h1>
					<p style="font-size:160%">http://oxmlxxe.github.io</p>
				</section>

			</div>

		</div>

		<script src="/reveal.js/lib/js/head.min.js"></script>
		<script src="/reveal.js/js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: '/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: '/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: '/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: '/reveal.js/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: '/reveal.js/plugin/zoom-js/zoom.js', async: true },
					{ src: '/reveal.js/plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
